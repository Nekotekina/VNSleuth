# VNSleuth
This is an experimental tool for offline machine translation of Japanese Visual Novels to English. For translation, it's currently designed to use locally-running [LLMs](https://en.wikipedia.org/wiki/Large_language_model), even though they are considered small and "dumb" compared to monsters like GPT4, they are still very complex, resource-hungry neural networks. Translated text is displayed in a terminal in realtime, and original text needs to be hooked and copied to the clipboard by 3rdparty tools like [Textractor](https://github.com/Artikash/Textractor). I am not interested in packaging translated text back into a VN ~~as I consider it inherently flawed and harmful idea~~. Initially I tried to send hooked text directly into the LLM, but the results did not satisfy me. Although it's also perfectly possible to take hooked text and send it wherever you like on a single-sentence basis, to a translator like deepl or to an LLM via OpenAI API, this is not interesting enough. The most interesting and promising thing about LLMs is that they are potentially able to generate coherent translation, while making sense of the previous sentences and overall setting, albeit not perfectly and not cheaply. And to do it properly, we also need to extract all the original text from the game files, which introduces more complications: different engines must be specifically supported, and extracting some of them might be tricky.

An example of running a VN with VNSleuth in the terminal on the right side. You can see Textractor icon on the left which is also running in the background, sending text to the clipboard.
![Screenshot of the 'Nekotsuku Sakura' with VNSleuth displaying some translation in the terminal.](/examples/screenshot1.png)
LLMs, especially smaller ones, tend to "hallucinate" and say weird things. I'm also unable to fine-tune them for better results, so I can only grab what little things are available in public. There are multiple open-weight LLMs available, made by some Chinese companies, that were trained on decent amount of Japanese texts. I had hopes for Orion, but something is wrong with it in llama.cpp, so I settled with Qwen for now.

I made VNSleuth for myself out of curiosity for new tech and also laziness. Despite having started learning Japanese around 2011, I still don't know most ideograms (less frequent ones) and my understanding of texts may range from nearly-perfect for casual lines of dialogues, to not understanding anything at all. I used to read VNs with a dictionary, but it's time-consuming and I seemingly hit the wall. I used to avoid any kind of MTL but it doesn't bother me anymore. LLMs, on the other hand, can at the same time provide pretty good translation for complex descriptive sentences, but may fail miserably at some casual lines of dialogues, due to weird text formatting, for example. It seems I can achieve much better understanding by reading both Japanese and translated lines, and with decent speed and lower effort. I still don't want to use any sort of online translator however, unless on specific occasion.

## Requirements
1. Linux machine capable of running VNs, with Wine and other things prepared. Xorg is required, Wayland support may be added later. Native Windows support may be added later, but its users demand fancy GUI for everything which is a PITA to implement. WSL might work in theory, but it's probably pointless, and I won't test it. No idea about other OSes.
1. Modern GPU with at least 16 GiB of VRAM for translating texts at acceptable speed. And that's a rough requirement for small LLMs that don't produce best output. 4060 Ti or RX 7600 XT might work although the latter is probably the slowest option. It's possible to run partially (lower VRAM req.) or completely on CPU, but it's way too slow and power-hungry.
1. Clone and compile [my fork of llama.cpp](https://github.com/Nekotekina/llama.cpp), make sure to follow instructions for GPU acceleration for your hardware. Other LLM backends may be supported in future.
1. Unless you know better what to do, download `qwen1_5-14b-chat.Q5_K_M.gguf` from [here](https://huggingface.co/Nekotekina/Qwen1.5-14B-Chat-GGUF-F32/tree/main). Technically you can use other models, like Yi-34B or Qwen1.5-72B, if you have sufficient resources, but requirements might be quite extreme. They should behave order of magnitude better, however.
1. Take llm_common.sh, llm_qwen14.sh, llm_qwen14vn.sh scripts from /tools/, **read and edit** them appropriately and place them in $HOME/bin directory.
1. Build `vnsleuth` by running make, `make install` will copy the executable into $HOME/bin.
1. Build `xclipmonitor` in tools/xclipmonitor by running make, `make install` will copy the executable into $HOME/bin.

## Workflow
1. Determine whether your VN's engine is supported. Extract all script files into a dedicated directory. Automated tool for script extraction may be added in future.

| Engine | Script location | Notes |
|:-------:|:-------:|:-------:|
| Buriko/ETH | data01000.arc | Extract data01000.arc with AE or GARbro |

2. Assuming you extracted scripts into `./Scripts/`, run `vnsleuth "./Scripts/"` to initialize the script directory. You should see the number of script lines, dumped furigana and other technical information.
2. Make sure `./Scripts/__vnsleuth_names.txt` was created and filled with all encountered names. Optionally, you can fill some of them manually. This is not required as VNSleuth will attempt to translate them automatically and fill this file accordingly, but that process may fail sometimes due to the nature of LLMs. Add English names after `:`, without spaces, and make sure the line ends with another `:`.
2. Create `./Scripts/__vnsleuth_prompt.txt` that contains basic information about the VN (like protagonist name, heroines, toponyms). Consult /examples/ in the repository. There is no strict format to the prompt, but try to keep it brief and avoid repeating the same words. The most important part is probably the first line and "Dictionary". Character names are usually provided on https://vndb.org/ and dumped furigana can sometimes provide important word readings.
2. Run `vnsleuth "./Scripts/" llm_qwen14vn.sh` (or use other appropriate set of llama.cpp arguments if you know what are you doing). Wait for, possibly, **hours**, until the translation is finished. Some unfortunate errors may appear.
2. Run `xclipmonitor | vnsleuth "./Scripts/"` and make sure there are no warnings. Now you can run VN with Textractor (use the extension to send hooked text to the clipboard) or some other tool which can copy text to the clipboard automatically. Some hooks may work incorrectly, you may need to add appropriate custom hook if necessary.

## Disclaimer
Don't share translation cache as it contains original text and thus could be a copyright infringement. Generate your own translations under Fair Use terms.
